<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rock Paper Scissors - Live Battle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            overflow-x: hidden;
        }

        /* Login Screen */
        #loginScreen {
            background: linear-gradient(145deg, #2a2a3e, #1f1f2e);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        #loginScreen h1 {
            font-size: 2em;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }

        /* Added styles for login/signup forms */
        .auth-form {
            margin: 20px 0;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(0, 212, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .divider {
            margin: 20px 0;
            text-align: center;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
        }

        .divider span {
            background: linear-gradient(145deg, #2a2a3e, #1f1f2e);
            padding: 0 15px;
            position: relative;
            z-index: 1;
            color: rgba(255, 255, 255, 0.6);
        }

        .toggle-auth {
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }

        .toggle-auth a {
            color: #00d4ff;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }

        .toggle-auth a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: rgba(255, 51, 102, 0.2);
            border: 1px solid rgba(255, 51, 102, 0.5);
            color: #ff3366;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .success-message {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.5);
            color: #00ff88;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(145deg, #0099ff, #0077cc);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 153, 255, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 153, 255, 0.5);
        }

        /* Added disabled button style */
        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Lobby Screen */
        #lobbyScreen {
            background: linear-gradient(145deg, #2a2a3e, #1f1f2e);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 90%;
        }

        .user-info {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }

        .wallet-balance {
            font-size: 2em;
            color: #ffd700;
            margin: 10px 0;
        }

        /* Added invitation notification area */
        #invitationContainer {
            background: rgba(0, 212, 255, 0.2);
            border: 2px solid rgba(0, 212, 255, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .online-players {
            margin: 20px 0;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 153, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 153, 255, 0.3);
        }

        .challenge-btn {
            padding: 10px 20px;
            background: linear-gradient(145deg, #00ff88, #00cc66);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .challenge-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        /* Game Machine */
        #gameScreen {
            display: none;
            max-width: 800px;
            width: 95%;
            margin: 20px auto;
        }

        .game-machine {
            background: linear-gradient(145deg, #3a3a4e, #2a2a3e);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7),
                        inset 0 2px 0 rgba(255, 255, 255, 0.1),
                        inset 0 -2px 0 rgba(0, 0, 0, 0.5);
            position: relative;
        }

        /* Octagonal Screen */
        .game-screen {
            background: linear-gradient(145deg, #1a1a2e, #0f0f1e);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 400px;
            position: relative;
            clip-path: polygon(15% 0%, 85% 0%, 100% 15%, 100% 85%, 85% 100%, 15% 100%, 0% 85%, 0% 15%);
            box-shadow: inset 0 5px 20px rgba(0, 0, 0, 0.8),
                        0 0 30px rgba(0, 212, 255, 0.2);
        }

        .video-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .video-wrapper {
            flex: 1;
            min-width: 200px;
            max-width: 350px;
            position: relative;
        }

        .player-video {
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: 15px;
            object-fit: cover;
            border: 3px solid rgba(0, 212, 255, 0.5);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .player-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .player-balance {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 215, 0, 0.9);
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .game-status {
            text-align: center;
            padding: 20px;
            font-size: 1.5em;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            margin: 20px 0;
        }

        .countdown {
            font-size: 4em;
            color: #ff3366;
            text-shadow: 0 0 30px rgba(255, 51, 102, 0.8);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .game-btn {
            flex: 1;
            min-width: 150px;
            max-width: 200px;
            padding: 30px 20px;
            background: linear-gradient(145deg, #4a4a5e, #3a3a4e);
            border: 3px solid rgba(0, 212, 255, 0.3);
            border-radius: 20px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .game-btn:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 212, 255, 0.8);
            box-shadow: 0 15px 40px rgba(0, 212, 255, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .game-btn.selected {
            background: linear-gradient(145deg, #00d4ff, #0099ff);
            border-color: #00ff88;
            box-shadow: 0 0 40px rgba(0, 212, 255, 0.8);
        }

        .game-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-icon {
            font-size: 2em;
            display: block;
            margin-bottom: 10px;
        }

        /* Result Display */
        .result-display {
            text-align: center;
            padding: 40px;
            font-size: 2em;
            font-weight: bold;
            animation: fadeIn 0.5s;
        }

        .result-display.win {
            color: #00ff88;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
        }

        .result-display.lose {
            color: #ff3366;
            text-shadow: 0 0 30px rgba(255, 51, 102, 0.8);
        }

        .result-display.draw {
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Bet Input */
        .bet-container {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin: 20px 0;
        }

        .bet-input {
            padding: 15px;
            font-size: 1.2em;
            border-radius: 10px;
            border: 2px solid rgba(0, 212, 255, 0.5);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            width: 200px;
            margin: 10px;
        }

        .action-btn {
            padding: 15px 30px;
            margin: 10px;
            background: linear-gradient(145deg, #00ff88, #00cc66);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.5);
        }

        .action-btn.cancel {
            background: linear-gradient(145deg, #ff3366, #cc0033);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-screen {
                min-height: 300px;
            }

            .player-video {
                height: 180px;
            }

            .game-btn {
                min-width: 100px;
                padding: 20px 15px;
                font-size: 1em;
            }

            .btn-icon {
                font-size: 1.5em;
            }

            .countdown {
                font-size: 3em;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Transaction History */
        .history-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }

        .history-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.9em;
        }

        .logout-btn {
            padding: 10px 20px;
            background: linear-gradient(145deg, #ff3366, #cc0033);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>
     Updated login screen with proper signup/login forms 
    <div id="loginScreen">
        <h1>🎮 Rock Paper Scissors</h1>
        <p style="margin-bottom: 30px;">Live Battle Arena</p>

        <div id="messageContainer"></div>

         Login Form 
        <div id="loginForm" class="auth-form">
            <input type="email" id="loginEmail" class="form-input" placeholder="Email" autocomplete="email">
            <input type="password" id="loginPassword" class="form-input" placeholder="Password" autocomplete="current-password">
            <button class="login-btn" onclick="loginWithEmail()">🔐 Login</button>
            
            <div class="divider"><span>OR</span></div>
            
            <button class="login-btn" onclick="loginWithGoogle()">🔐 Login with Google</button>
            
            <div class="toggle-auth">
                Don't have an account? <a onclick="showSignupForm()">Sign up</a>
            </div>
        </div>

         Signup Form 
        <div id="signupForm" class="auth-form hidden">
            <input type="text" id="signupName" class="form-input" placeholder="Display Name" autocomplete="name">
            <input type="email" id="signupEmail" class="form-input" placeholder="Email" autocomplete="email">
            <input type="password" id="signupPassword" class="form-input" placeholder="Password (min 6 characters)" autocomplete="new-password">
            <input type="password" id="signupConfirmPassword" class="form-input" placeholder="Confirm Password" autocomplete="new-password">
            <button class="login-btn" onclick="signupWithEmail()">📝 Create Account</button>
            
            <div class="divider"><span>OR</span></div>
            
            <button class="login-btn" onclick="loginWithGoogle()">🔐 Sign up with Google</button>
            
            <div class="toggle-auth">
                Already have an account? <a onclick="showLoginForm()">Login</a>
            </div>
        </div>
    </div>

     Lobby Screen 
    <div id="lobbyScreen" class="hidden">
        <div class="user-info">
            <h2 id="userName">Welcome!</h2>
            <div class="wallet-balance">💰 <span id="walletBalance">0</span> coins</div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="bet-container">
            <h3>Set Your Bet Amount</h3>
            <input type="number" id="betAmount" class="bet-input" min="5" value="10" placeholder="Min: 5 coins">
        </div>

        <!-- Invitation notification area -->
        <div id="invitationContainer" class="hidden">
            <h3>🎮 Game Invitation!</h3>
            <p id="invitationText" style="margin: 15px 0; font-size: 1.1em;"></p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <button class="action-btn" onclick="acceptInvitation()">✅ Accept</button>
                <button class="action-btn cancel" onclick="declineInvitation()">❌ Decline</button>
            </div>
        </div>

        <div class="online-players">
            <h3>🌐 Online Players</h3>
            <div id="playersList"></div>
        </div>

        <div class="history-section">
            <h3>📊 Recent Games</h3>
            <div id="historyList"></div>
        </div>
    </div>

     Game Screen 
    <div id="gameScreen">
        <div class="game-machine">
            <div class="game-screen">
                <div class="video-container">
                    <div class="video-wrapper">
                        <video id="localVideo" class="player-video" autoplay muted playsinline></video>
                        <div class="player-label" id="localPlayerName">You</div>
                        <div class="player-balance" id="localPlayerBalance">0 💰</div>
                    </div>
                    <div class="video-wrapper">
                        <video id="remoteVideo" class="player-video" autoplay playsinline></video>
                        <div class="player-label" id="remotePlayerName">Opponent</div>
                        <div class="player-balance" id="remotePlayerBalance">0 💰</div>
                    </div>
                </div>

                <div class="game-status" id="gameStatus">
                    Waiting for opponent...
                </div>
            </div>

            <div class="controls" id="gameControls">
                <button class="game-btn" id="rockBtn" onclick="makeChoice('rock')" disabled>
                    <span class="btn-icon">🪨</span>
                    Rock
                </button>
                <button class="game-btn" id="paperBtn" onclick="makeChoice('paper')" disabled>
                    <span class="btn-icon">📄</span>
                    Paper
                </button>
                <button class="game-btn" id="scissorsBtn" onclick="makeChoice('scissors')" disabled>
                    <span class="btn-icon">✂️</span>
                    Scissors
                </button>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="action-btn cancel" onclick="exitGame()">Exit Game</button>
            </div>
        </div>
    </div>

     Firebase SDK 
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCjdjNpyDG1wXGyxG65Pa0jlehVGW52u_Y",
            authDomain: "piedra-papel-o-tijeras-5ae53.firebaseapp.com",
            databaseURL: "https://piedra-papel-o-tijeras-5ae53-default-rtdb.firebaseio.com",
            projectId: "piedra-papel-o-tijeras-5ae53",
            storageBucket: "piedra-papel-o-tijeras-5ae53.firebasestorage.app",
            messagingSenderId: "394850327081",
            appId: "1:394850327081:web:96d0e21ce3bf4e67da1a38",
            measurementId: "G-C3VE5H0Y3S"
        };
        // ============================================
        // Initialize Firebase
        // ============================================
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ============================================
        // GLOBAL STATE
        // ============================================
        let currentUser = null;
        let currentGameId = null;
        let localStream = null;
        let peerConnection = null;
        let gameListener = null;
        let playersListener = null;
        let invitationListener = null;
        let pendingInvitation = null;

        // WebRTC Configuration
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // Sound effects (using Web Audio API)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playBeep(frequency = 800, duration = 200) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        function playCountdownSound() {
            playBeep(600, 150);
        }

        function playAlarmSound() {
            playBeep(1200, 300);
        }

        function playWinSound() {
            playBeep(800, 100);
            setTimeout(() => playBeep(1000, 100), 100);
            setTimeout(() => playBeep(1200, 200), 200);
        }

        function playLoseSound() {
            playBeep(400, 100);
            setTimeout(() => playBeep(300, 100), 100);
            setTimeout(() => playBeep(200, 200), 200);
        }

        function playDrawSound() {
            playBeep(600, 150);
            setTimeout(() => playBeep(600, 150), 200);
        }

        function playClickSound() {
            playBeep(1000, 50);
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                initializeUser();
                showLobby();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            clearMessage();
        }

        function showSignupForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            clearMessage();
        }

        function showMessage(message, isError = false) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>`;
        }

        function clearMessage() {
            document.getElementById('messageContainer').innerHTML = '';
        }

        async function loginWithEmail() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showMessage('Please enter both email and password', true);
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('Login successful!');
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/user-not-found') {
                    showMessage('No account found with this email. Please sign up first.', true);
                } else if (error.code === 'auth/wrong-password') {
                    showMessage('Incorrect password. Please try again.', true);
                } else if (error.code === 'auth/invalid-email') {
                    showMessage('Invalid email address.', true);
                } else {
                    showMessage('Login failed: ' + error.message, true);
                }
            }
        }

        async function signupWithEmail() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            
            // Validation
            if (!name) {
                showMessage('Please enter your display name', true);
                return;
            }

            if (!email) {
                showMessage('Please enter your email', true);
                return;
            }

            if (!password) {
                showMessage('Please enter a password', true);
                return;
            }

            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long', true);
                return;
            }

            if (password !== confirmPassword) {
                showMessage('Passwords do not match', true);
                return;
            }

            try {
                // Create user account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Update display name
                await userCredential.user.updateProfile({
                    displayName: name
                });

                showMessage('Account created successfully! Welcome!');
                
                // Clear form
                document.getElementById('signupName').value = '';
                document.getElementById('signupEmail').value = '';
                document.getElementById('signupPassword').value = '';
                document.getElementById('signupConfirmPassword').value = '';
                
            } catch (error) {
                console.error('Signup error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showMessage('This email is already registered. Please login instead.', true);
                } else if (error.code === 'auth/invalid-email') {
                    showMessage('Invalid email address.', true);
                } else if (error.code === 'auth/weak-password') {
                    showMessage('Password is too weak. Please use a stronger password.', true);
                } else {
                    showMessage('Signup failed: ' + error.message, true);
                }
            }
        }

        async function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Google login error:', error);
                showMessage('Google login failed: ' + error.message, true);
            }
        }

        // ============================================
        // USER INITIALIZATION
        // ============================================
        async function initializeUser() {
            const userRef = database.ref(`users/${currentUser.uid}`);
            
            // Check if user exists
            const snapshot = await userRef.once('value');
            if (!snapshot.exists()) {
                // New user - initialize wallet
                await userRef.set({
                    email: currentUser.email,
                    displayName: currentUser.displayName || currentUser.email.split('@')[0],
                    wallet: 100, // Starting balance
                    status: 'online',
                    createdAt: Date.now()
                });
            } else {
                // Update status
                await userRef.update({ status: 'online' });
            }

            // Listen to wallet changes
            userRef.child('wallet').on('value', snapshot => {
                const balance = snapshot.val() || 0;
                document.getElementById('walletBalance').textContent = balance;
            });

            // Load transaction history
            loadHistory();

            // Listen to online players
            listenToPlayers();

            listenToInvitations();

            // Handle disconnect
            userRef.child('status').onDisconnect().set('offline');
        }

        // ============================================
        // LOBBY FUNCTIONS
        // ============================================
        function listenToPlayers() {
            if (playersListener) playersListener.off();
            
            playersListener = database.ref('users');
            playersListener.on('value', snapshot => {
                const players = snapshot.val();
                const playersList = document.getElementById('playersList');
                playersList.innerHTML = '';

                if (!players) return;

                Object.keys(players).forEach(uid => {
                    if (uid === currentUser.uid) return; // Skip self
                    
                    const player = players[uid];
                    if (player.status === 'online') {
                        const div = document.createElement('div');
                        div.className = 'player-item';
                        div.innerHTML = `
                            <span>${player.displayName || player.email}</span>
                            <button class="challenge-btn" onclick="challengePlayer('${uid}', '${player.displayName || player.email}')">
                                ⚔️ Challenge
                            </button>
                        `;
                        playersList.appendChild(div);
                    }
                });

                if (playersList.children.length === 0) {
                    playersList.innerHTML = '<p style="text-align: center; opacity: 0.6;">No players online</p>';
                }
            });
        }

        function listenToInvitations() {
            if (invitationListener) invitationListener.off();
            
            invitationListener = database.ref(`invitations/${currentUser.uid}`);
            invitationListener.on('child_added', async snapshot => {
                const invitation = snapshot.val();
                if (invitation && invitation.status === 'pending') {
                    pendingInvitation = {
                        id: snapshot.key,
                        ...invitation
                    };
                    
                    // Show invitation UI
                    document.getElementById('invitationText').textContent = 
                        `${invitation.fromName} challenges you to a ${invitation.betAmount} coins battle!`;
                    document.getElementById('invitationContainer').classList.remove('hidden');
                    
                    // Play notification sound
                    playAlarmSound();
                }
            });

            // Listen for invitation updates (accepted/declined)
            invitationListener.on('child_changed', async snapshot => {
                const invitation = snapshot.val();
                if (invitation.status === 'accepted' && invitation.from === currentUser.uid) {
                    // Our invitation was accepted, start the game
                    currentGameId = invitation.gameId;
                    showGame();
                    setupGame();
                } else if (invitation.status === 'declined' && invitation.from === currentUser.uid) {
                    alert('Your invitation was declined.');
                }
            });
        }

        async function acceptInvitation() {
            if (!pendingInvitation) return;

            // Check if user has enough coins
            const walletSnapshot = await database.ref(`users/${currentUser.uid}/wallet`).once('value');
            const currentBalance = walletSnapshot.val() || 0;

            if (currentBalance < pendingInvitation.betAmount) {
                alert('Insufficient balance!');
                await declineInvitation();
                return;
            }

            await database.ref(`invitations/${currentUser.uid}/${pendingInvitation.id}`).update({
                status: 'accepted'
            });

            await database.ref(`invitations/${pendingInvitation.from}/${pendingInvitation.id}`).update({
                status: 'accepted'
            });

            await database.ref(`users/${currentUser.uid}`).update({ 
                status: 'in-game',
                currentGame: pendingInvitation.gameId
            });

            // Hide invitation UI
            document.getElementById('invitationContainer').classList.add('hidden');

            // Start the game
            currentGameId = pendingInvitation.gameId;
            pendingInvitation = null;
            
            showGame();
            setupGame();
        }

        async function declineInvitation() {
            if (!pendingInvitation) return;

            // Update invitation status
            await database.ref(`invitations/${currentUser.uid}/${pendingInvitation.id}`).update({
                status: 'declined'
            });

            // Also update the sender's invitation
            await database.ref(`invitations/${pendingInvitation.from}/${pendingInvitation.id}`).update({
                status: 'declined'
            });

            // Delete the game
            await database.ref(`games/${pendingInvitation.gameId}`).remove();

            // Hide invitation UI
            document.getElementById('invitationContainer').classList.add('hidden');
            pendingInvitation = null;
        }

        async function challengePlayer(opponentId, opponentName) {
            const betAmount = parseInt(document.getElementById('betAmount').value);
            
            if (betAmount < 5) {
                alert('Minimum bet is 5 coins!');
                return;
            }

            // Check if user has enough coins
            const walletSnapshot = await database.ref(`users/${currentUser.uid}/wallet`).once('value');
            const currentBalance = walletSnapshot.val() || 0;

            if (currentBalance < betAmount) {
                alert('Insufficient balance!');
                return;
            }

            const gameRef = database.ref('games').push();
            currentGameId = gameRef.key;

            await gameRef.set({
                player1: currentUser.uid,
                player2: opponentId,
                player1Name: currentUser.displayName || currentUser.email.split('@')[0],
                player2Name: opponentName,
                betAmount: betAmount,
                status: 'waiting',
                createdAt: Date.now()
            });

            const invitationRef = database.ref(`invitations/${opponentId}`).push();
            const invitationId = invitationRef.key;

            await invitationRef.set({
                from: currentUser.uid,
                fromName: currentUser.displayName || currentUser.email.split('@')[0],
                to: opponentId,
                toName: opponentName,
                betAmount: betAmount,
                gameId: currentGameId,
                status: 'pending',
                createdAt: Date.now()
            });

            await database.ref(`invitations/${currentUser.uid}/${invitationId}`).set({
                from: currentUser.uid,
                fromName: currentUser.displayName || currentUser.email.split('@')[0],
                to: opponentId,
                toName: opponentName,
                betAmount: betAmount,
                gameId: currentGameId,
                status: 'pending',
                createdAt: Date.now()
            });

            await database.ref(`users/${currentUser.uid}`).update({ 
                status: 'waiting',
                currentGame: currentGameId
            });

            alert(`Invitation sent to ${opponentName}! Waiting for response...`);
            
            const senderInvitationRef = database.ref(`invitations/${currentUser.uid}/${invitationId}`);
            senderInvitationRef.on('value', async snapshot => {
                const invitation = snapshot.val();
                if (invitation && invitation.status === 'accepted') {
                    // Opponent accepted, start the game
                    senderInvitationRef.off(); // Stop listening
                    await database.ref(`users/${currentUser.uid}`).update({ 
                        status: 'in-game'
                    });
                    showGame();
                    setupGame();
                } else if (invitation && invitation.status === 'declined') {
                    // Opponent declined
                    senderInvitationRef.off(); // Stop listening
                    await database.ref(`users/${currentUser.uid}`).update({ 
                        status: 'online',
                        currentGame: null
                    });
                    await database.ref(`games/${currentGameId}`).remove();
                    currentGameId = null;
                    alert('Your invitation was declined.');
                }
            });
        }

        async function loadHistory() {
            const historyRef = database.ref(`history/${currentUser.uid}`).limitToLast(5);
            historyRef.on('value', snapshot => {
                const history = snapshot.val();
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';

                if (!history) {
                    historyList.innerHTML = '<p style="text-align: center; opacity: 0.6;">No games yet</p>';
                    return;
                }

                Object.values(history).reverse().forEach(game => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    const resultColor = game.result === 'win' ? '#00ff88' : game.result === 'lose' ? '#ff3366' : '#ffd700';
                    div.innerHTML = `
                        <span style="color: ${resultColor}; font-weight: bold;">${game.result.toUpperCase()}</span>
                        vs ${game.opponent} | ${game.amount > 0 ? '+' : ''}${game.amount} coins
                    `;
                    historyList.appendChild(div);
                });
            });
        }

        // ============================================
        // GAME FUNCTIONS
        // ============================================
        function updateGameUI(game) {
            if (!game) return;

            // Update player names
            if (game.player1Name) {
                document.getElementById('localPlayerName').textContent = game.player1Name;
            }
            if (game.player2Name) {
                document.getElementById('remotePlayerName').textContent = game.player2Name;
            }

            // Update bet display in game status if in waiting state
            if (game.status === 'waiting') {
                document.getElementById('gameStatus').textContent = `Bet: ${game.betAmount} coins - Waiting for opponent...`;
            }
        }

        async function setupGame() {
            document.getElementById('gameStatus').innerHTML = 'Setting up video...';

            try {
                // Try to get both video and audio
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                document.getElementById('localVideo').srcObject = localStream;
            } catch (error) {
                console.error('Error accessing media devices:', error);
                
                // Try video only
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: false 
                    });
                    document.getElementById('localVideo').srcObject = localStream;
                    document.getElementById('gameStatus').innerHTML = 'Video only (no microphone detected)';
                } catch (videoError) {
                    // Try audio only
                    try {
                        localStream = await navigator.mediaDevices.getUserMedia({ 
                            video: false, 
                            audio: true 
                        });
                        document.getElementById('gameStatus').innerHTML = 'Audio only (no camera detected)';
                    } catch (audioError) {
                        // No media devices available - continue without them
                        console.warn('No media devices available, continuing without video/audio');
                        document.getElementById('gameStatus').innerHTML = 'Playing without video/audio';
                        
                        // Hide video containers
                        document.querySelector('.video-container').style.display = 'none';
                        
                        // Show a message
                        const message = document.createElement('div');
                        message.style.cssText = 'text-align: center; padding: 20px; background: rgba(255, 153, 0, 0.2); border-radius: 10px; margin: 20px 0;';
                        message.innerHTML = `
                            <p style="color: #ff9900; font-weight: bold;">⚠️ Camera/Microphone not available</p>
                            <p style="font-size: 0.9em; margin-top: 10px;">
                                Playing without video. Make sure to allow camera/microphone permissions for the full experience!
                            </p>
                        `;
                        document.querySelector('.game-screen').insertBefore(message, document.getElementById('gameStatus'));
                    }
                }
            }

            // Listen to game state
            if (gameListener) gameListener.off();
            gameListener = database.ref(`games/${currentGameId}`);
            
            gameListener.on('value', async snapshot => {
                const game = snapshot.val();
                if (!game) return;

                updateGameUI(game);

                // Handle game status changes
                if (game.status === 'countdown') {
                    startCountdown();
                } else if (game.status === 'playing') {
                    enableButtons();
                } else if (game.status === 'finished') {
                    showResult(game);
                }
            });

            // Setup WebRTC only if we have a stream
            if (localStream) {
                setupWebRTC();
            }

            // Update player info
            const gameSnapshot = await database.ref(`games/${currentGameId}`).once('value');
            const game = gameSnapshot.val();
            
            const isPlayer1 = game.player1 === currentUser.uid;
            
            if (isPlayer1) {
                document.getElementById('localPlayerName').textContent = game.player1Name;
                document.getElementById('remotePlayerName').textContent = game.player2Name;
            } else {
                document.getElementById('localPlayerName').textContent = game.player2Name;
                document.getElementById('remotePlayerName').textContent = game.player1Name;
            }

            // Load balances
            const p1Balance = await database.ref(`users/${game.player1}/wallet`).once('value');
            const p2Balance = await database.ref(`users/${game.player2}/wallet`).once('value');
            
            if (isPlayer1) {
                document.getElementById('localPlayerBalance').textContent = `${p1Balance.val()} 💰`;
                document.getElementById('remotePlayerBalance').textContent = `${p2Balance.val()} 💰`;
            } else {
                document.getElementById('localPlayerBalance').textContent = `${p2Balance.val()} 💰`;
                document.getElementById('remotePlayerBalance').textContent = `${p1Balance.val()} 💰`;
            }

            if (isPlayer1 && game.status === 'waiting') {
                setTimeout(async () => {
                    await database.ref(`games/${currentGameId}`).update({ status: 'countdown' });
                }, 3000);
            }
        }

        async function startCountdown() {
            document.getElementById('gameStatus').innerHTML = '<div class="countdown">3</div>';
            playCountdownSound();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            document.getElementById('gameStatus').innerHTML = '<div class="countdown">2</div>';
            playCountdownSound();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            document.getElementById('gameStatus').innerHTML = '<div class="countdown">1</div>';
            playAlarmSound();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            document.getElementById('gameStatus').innerHTML = '<div class="countdown">GO!</div>';
            playAlarmSound();
            
            await database.ref(`games/${currentGameId}`).update({ status: 'playing' });
        }

        function enableButtons() {
            document.getElementById('rockBtn').disabled = false;
            document.getElementById('paperBtn').disabled = false;
            document.getElementById('scissorsBtn').disabled = false;
            document.getElementById('gameStatus').textContent = 'Make your choice!';
        }

        async function makeChoice(choice) {
            playClickSound();
            
            // Disable all buttons
            document.getElementById('rockBtn').disabled = true;
            document.getElementById('paperBtn').disabled = true;
            document.getElementById('scissorsBtn').disabled = true;

            // Highlight selected button
            document.getElementById(`${choice}Btn`).classList.add('selected');

            const gameSnapshot = await database.ref(`games/${currentGameId}`).once('value');
            const game = gameSnapshot.val();
            const isPlayer1 = game.player1 === currentUser.uid;

            // Update choice
            const updates = {};
            if (isPlayer1) {
                updates.player1Choice = choice;
            } else {
                updates.player2Choice = choice;
            }

            await database.ref(`games/${currentGameId}`).update(updates);

            document.getElementById('gameStatus').textContent = 'Waiting for opponent...';

            // Check if both players made their choice
            const updatedSnapshot = await database.ref(`games/${currentGameId}`).once('value');
            const updatedGame = updatedSnapshot.val();

            if (updatedGame.player1Choice && updatedGame.player2Choice) {
                // Determine winner
                const result = determineWinner(updatedGame.player1Choice, updatedGame.player2Choice);
                
                await database.ref(`games/${currentGameId}`).update({
                    status: 'finished',
                    result: result,
                    finishedAt: Date.now()
                });

                // Update wallets
                await updateWallets(updatedGame, result);
            }
        }

        function determineWinner(choice1, choice2) {
            if (choice1 === choice2) return 'draw';
            
            if (
                (choice1 === 'rock' && choice2 === 'scissors') ||
                (choice1 === 'scissors' && choice2 === 'paper') ||
                (choice1 === 'paper' && choice2 === 'rock')
            ) {
                return 'player1';
            }
            
            return 'player2';
        }

        async function updateWallets(game, result) {
            const betAmount = game.betAmount;

            if (result === 'draw') {
                // Refund both players
                await addToHistory(game.player1, game.player2Name, 'draw', 0);
                await addToHistory(game.player2, game.player1Name, 'draw', 0);
            } else {
                const winner = result === 'player1' ? game.player1 : game.player2;
                const loser = result === 'player1' ? game.player2 : game.player1;
                const winnerName = result === 'player1' ? game.player1Name : game.player2Name;
                const loserName = result === 'player1' ? game.player2Name : game.player1Name;

                // Update winner wallet
                const winnerWalletRef = database.ref(`users/${winner}/wallet`);
                const winnerSnapshot = await winnerWalletRef.once('value');
                await winnerWalletRef.set((winnerSnapshot.val() || 0) + (betAmount * 2));

                // Update loser wallet
                const loserWalletRef = database.ref(`users/${loser}/wallet`);
                const loserSnapshot = await loserWalletRef.once('value');
                await loserWalletRef.set((loserSnapshot.val() || 0) - betAmount);

                // Add to history
                await addToHistory(winner, loserName, 'win', betAmount * 2);
                await addToHistory(loser, winnerName, 'lose', -betAmount);
            }
        }

        async function addToHistory(userId, opponent, result, amount) {
            await database.ref(`history/${userId}`).push({
                opponent: opponent,
                result: result,
                amount: amount,
                timestamp: Date.now()
            });
        }

        function showResult(game) {
            const isPlayer1 = game.player1 === currentUser.uid;
            let resultText = '';
            let resultClass = '';

            if (game.result === 'draw') {
                resultText = '🤝 DRAW!';
                resultClass = 'draw';
                playDrawSound();
            } else if (
                (game.result === 'player1' && isPlayer1) ||
                (game.result === 'player2' && !isPlayer1)
            ) {
                resultText = `🎉 YOU WIN! +${game.betAmount * 2} coins`;
                resultClass = 'win';
                playWinSound();
            } else {
                resultText = `😢 YOU LOSE! -${game.betAmount} coins`;
                resultClass = 'lose';
                playLoseSound();
            }

            const p1Icon = getChoiceIcon(game.player1Choice);
            const p2Icon = getChoiceIcon(game.player2Choice);

            document.getElementById('gameStatus').innerHTML = `
                <div class="result-display ${resultClass}">
                    ${resultText}
                    <div style="font-size: 0.5em; margin-top: 20px;">
                        ${game.player1Name}: ${p1Icon} vs ${game.player2Name}: ${p2Icon}
                    </div>
                </div>
            `;

            // Show play again button after 3 seconds
            setTimeout(() => {
                document.getElementById('gameStatus').innerHTML += `
                    <button class="action-btn" onclick="exitGame()">Back to Lobby</button>
                `;
            }, 3000);
        }

        function getChoiceIcon(choice) {
            const icons = { rock: '🪨', paper: '📄', scissors: '✂️' };
            return icons[choice] || '❓';
        }

        async function exitGame() {
            // Clean up
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            if (gameListener) {
                gameListener.off();
                gameListener = null;
            }

            if (currentUser) {
                await database.ref(`users/${currentUser.uid}`).update({
                    status: 'online',
                    currentGame: null
                });
            }

            // Reset UI
            document.getElementById('rockBtn').classList.remove('selected');
            document.getElementById('paperBtn').classList.remove('selected');
            document.getElementById('scissorsBtn').classList.remove('selected');

            currentGameId = null;
            showLobby();
        }

        async function logout() {
            if (currentUser) {
                await database.ref(`users/${currentUser.uid}`).update({
                    status: 'offline',
                    currentGame: null
                });
            }
            
            // Clean up listeners
            if (playersListener) playersListener.off();
            if (invitationListener) invitationListener.off();
            if (gameListener) gameListener.off();
            
            await auth.signOut();
        }

        // ============================================
        // WEBRTC SETUP
        // ============================================
        async function setupWebRTC() {
            if (!localStream) {
                console.log('No local stream available, skipping WebRTC setup');
                return;
            }

            peerConnection = new RTCPeerConnection(rtcConfig);

            // Add local stream
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Handle remote stream
            peerConnection.ontrack = event => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    const gameSnapshot = database.ref(`games/${currentGameId}`);
                    const isPlayer1 = currentUser.uid === gameSnapshot.player1;
                    
                    database.ref(`games/${currentGameId}/ice/${isPlayer1 ? 'player1' : 'player2'}`).push({
                        candidate: event.candidate.toJSON()
                    });
                }
            };

            // Determine if we should create offer
            const gameSnapshot = await database.ref(`games/${currentGameId}`).once('value');
            const game = gameSnapshot.val();
            const isPlayer1 = game.player1 === currentUser.uid;

            if (isPlayer1) {
                // Player 1 creates offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                await database.ref(`games/${currentGameId}/offer`).set({
                    sdp: offer.sdp,
                    type: offer.type
                });
            } else {
                // Player 2 waits for offer and creates answer
                database.ref(`games/${currentGameId}/offer`).on('value', async snapshot => {
                    const offer = snapshot.val();
                    if (offer && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                        
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        
                        await database.ref(`games/${currentGameId}/answer`).set({
                            sdp: answer.sdp,
                            type: answer.type
                        });
                    }
                });
            }

            // Listen for answer (Player 1)
            if (isPlayer1) {
                database.ref(`games/${currentGameId}/answer`).on('value', async snapshot => {
                    const answer = snapshot.val();
                    if (answer && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    }
                });
            }

            // Listen for ICE candidates
            database.ref(`games/${currentGameId}/ice/${isPlayer1 ? 'player2' : 'player1'}`).on('child_added', async snapshot => {
                const candidate = snapshot.val().candidate;
                if (candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            });
        }

        // ============================================
        // UI NAVIGATION
        // ============================================
        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('gameScreen').style.display = 'none';
            showLoginForm();
        }

        function showLobby() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('lobbyScreen').classList.remove('hidden');
            document.getElementById('gameScreen').style.display = 'none';

            if (currentUser) {
                document.getElementById('userName').textContent = `Welcome, ${currentUser.displayName || currentUser.email.split('@')[0]}!`;
            }
        }

        function showGame() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('gameScreen').style.display = 'block';
        }
    </script>
</body>
</html>
